//@version=6
indicator(title="Relative Strength Index", shorttitle="RSI", timeframe="", timeframe_gaps=true)

// Inputs
rsiLength = input.int(14, minval=1, title="RSI Length")
rsiSource = input.source(close, "Source")
maType = input.string("EMA", "Smoothing", options = ["None", "SMA", "EMA"])
maLength = input.int(14, "Smoothing Length", display = display.data_window)

// Calculate RSI
change = ta.change(rsiSource)
up = ta.rma(math.max(change, 0), rsiLength)
down = ta.rma(-math.min(change, 0), rsiLength)
rsi = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

// Smoothing MA
smoothMA = switch maType
    "SMA" => ta.sma(rsi, maLength)
    "EMA" => ta.ema(rsi, maLength)
    => rsi

// A/D Divergence Detection
var cumVol = 0.
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")
ad = ta.cum(close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume)

ad_trend = ad > ta.sma(ad, 5)
rsi_trend = rsi > 50
divergence = ad_trend != rsi_trend

// Divergence Alert Conditions
bullish_divergence = ad_trend and not rsi_trend and rsi < 50
bearish_divergence = not ad_trend and rsi_trend and rsi > 50
alertcondition(bullish_divergence, title = 'Bullish Divergence', message = 'Bullish Divergence: A/D trending up but RSI trending down')
alertcondition(bearish_divergence, title = 'Bearish Divergence', message = 'Bearish Divergence: A/D trending down but RSI trending up')

// Plot RSI
plot(rsi, "RSI", color=#7E57C2, linewidth=2)
plot(smoothMA, "Smoothing MA", color=#DDDD44, linewidth=2)

// Overbought/Oversold levels
hline(70, "Overbought", color=#787B86)
hline(50, "Midline", color=color.new(#787B86, 50))
hline(30, "Oversold", color=#787B86)

// Color-coded zones background
bgcolor(rsi > 70 ? color.new(color.red, 85) : (rsi < 30 ? color.new(color.green, 85) : na), title = "Overbought/Oversold Zone")

// Divergence background alert
bgcolor(bullish_divergence ? color.new(color.green, 85) : (bearish_divergence ? color.new(color.red, 85) : na), title = "Divergence Background")
