//@version=6
indicator(title="ACCD Divergence Optimizer", shorttitle="ACCD-DIV", overlay=false)

// ====== INPUT PARAMETERS ======
fast_length = input.int(12, "MACD Fast Length")
slow_length = input.int(26, "MACD Slow Length")
signal_length = input.int(9, "Signal Smoothing")
lookback = input.int(75, "Lookback Bars")
minStrength = input.float(0.5, "Min Divergence Strength (%)")
minSwingPercent = input.float(0.05, "Min Swing Size (%)")  // Filter tiny swings (0.05% = very small)
initBars = input.int(100, "Initialization Bars")  // Wait this many bars before signaling

// ====== ACCUMULATION/DISTRIBUTION CALCULATION ======
// Volume-weighted accumulation/distribution line
cumVol = ta.cum(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")

ad = ta.cum(close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume)

// ====== MACD CALCULATION (Based on Accumulation/Distribution) ======
fast_ma = ta.ema(ad, fast_length)
slow_ma = ta.ema(ad, slow_length)
macd = fast_ma - slow_ma
signal = ta.ema(macd, signal_length)
hist = macd - signal

// ====== DIVERGENCE DETECTION ======
// Track last 5 swing lows and highs with their MACD values
var array<float> swingLows = array.new<float>(5)
var array<float> swingLowMacds = array.new<float>(5)
var array<int> swingLowBars = array.new<int>(5)

var array<float> swingHighs = array.new<float>(5)
var array<float> swingHighMacds = array.new<float>(5)
var array<int> swingHighBars = array.new<int>(5)

// Calculate lows and highs at the top level (required by Pine Script)
lowestIn5 = ta.lowest(close, 5)
swingLowSize = ((close - lowestIn5) / close) * 100  // How much lower was the swing low
isSwingLow = close == lowestIn5 and swingLowSize >= minSwingPercent and bar_index > 5

highestIn5 = ta.highest(close, 5)
swingHighSize = ((highestIn5 - close) / close) * 100  // How much higher was the swing high
isSwingHigh = close == highestIn5 and swingHighSize >= minSwingPercent and bar_index > 5

// Initialize arrays with first set of values during startup
if bar_index < initBars
    if isSwingLow
        if array.size(swingLows) < 5
            array.push(swingLows, close)
            array.push(swingLowMacds, macd)
            array.push(swingLowBars, bar_index)
        else
            array.shift(swingLows)
            array.shift(swingLowMacds)
            array.shift(swingLowBars)
            array.push(swingLows, close)
            array.push(swingLowMacds, macd)
            array.push(swingLowBars, bar_index)
    
    if isSwingHigh
        if array.size(swingHighs) < 5
            array.push(swingHighs, close)
            array.push(swingHighMacds, macd)
            array.push(swingHighBars, bar_index)
        else
            array.shift(swingHighs)
            array.shift(swingHighMacds)
            array.shift(swingHighBars)
            array.push(swingHighs, close)
            array.push(swingHighMacds, macd)
            array.push(swingHighBars, bar_index)

// After initialization, continue tracking swings normally
if isSwingLow and bar_index >= initBars
    // Shift array left and add new swing low at end
    array.shift(swingLows)
    array.shift(swingLowMacds)
    array.shift(swingLowBars)
    array.push(swingLows, close)
    array.push(swingLowMacds, macd)
    array.push(swingLowBars, bar_index)

if isSwingHigh and bar_index >= initBars
    // Shift array left and add new swing high at end
    array.shift(swingHighs)
    array.shift(swingHighMacds)
    array.shift(swingHighBars)
    array.push(swingHighs, close)
    array.push(swingHighMacds, macd)
    array.push(swingHighBars, bar_index)

// ====== BULLISH DIVERGENCE ======
// Classic divergence: Price makes lower low but MACD makes higher low
// Fires ONLY when a swing low is detected AND price recovers ABOVE previous swing low
// AND current MACD is HIGHER than MACD at that previous swing low  
// AND MACD is above signal line (bullish momentum)

lowestSwingLow = array.min(swingLows)
lowestSwingLowIdx = array.indexof(swingLows, lowestSwingLow)
macdAtLowestSwingLow = array.get(swingLowMacds, lowestSwingLowIdx)

// Check if we're recovering FROM the swing low (price above it, MACD stronger)
priceRecoveringFromLow = close > lowestSwingLow
macdHigherLow = macd > macdAtLowestSwingLow * (1 + minStrength/100)
macdAboveSignal = macd > signal  // MACD above signal line = bullish momentum

// Bullish divergence: ONLY fires on new swing low detection with recovery + stronger MACD
// BUT only after initialization period
isInitialized = bar_index >= initBars
bullishDiv = isInitialized and isSwingLow and priceRecoveringFromLow and macdHigherLow and macdAboveSignal and array.size(swingLows) == 5

// ====== BEARISH DIVERGENCE ======
// Classic divergence: Price makes higher high but MACD makes lower high
// Fires ONLY when a swing high is detected AND price declines BELOW previous swing high
// AND current MACD is LOWER than MACD at that previous swing high
// AND MACD is below signal line (bearish momentum)
// AND the swing high is at least 5+ bars old (filter noise)

highestSwingHigh = array.max(swingHighs)
highestSwingHighIdx = array.indexof(swingHighs, highestSwingHigh)
macdAtHighestSwingHigh = array.get(swingHighMacds, highestSwingHighIdx)
barsFromHighestSwingHigh = array.get(swingHighBars, highestSwingHighIdx)

// Check if we're declining FROM the swing high (price below it, MACD weaker)
// AND the swing high is old enough (at least 5 bars ago)
priceDeclingFromHigh = close < highestSwingHigh
macdLowerHigh = macd < macdAtHighestSwingHigh * (1 - minStrength/100)
macdBelowSignal = macd < signal  // MACD below signal line = bearish momentum
swingHighOldEnough = (bar_index - barsFromHighestSwingHigh) >= 5

// Bearish divergence: ONLY fires on new swing high detection with decline + weaker MACD
// BUT only after initialization period
bearishDiv = isInitialized and isSwingHigh and priceDeclingFromHigh and macdLowerHigh and macdBelowSignal and array.size(swingHighs) == 5 and swingHighOldEnough

// ====== ALERTS ======
alertcondition(bullishDiv, title="Bullish Divergence", message="ðŸŸ¢ BULLISH DIVERGENCE - Price Low but MACD Higher - BUY SIGNAL")
alertcondition(bearishDiv, title="Bearish Divergence", message="ðŸ”´ BEARISH DIVERGENCE - Price High but MACD Lower - SELL SIGNAL")

// ====== VISUALS ======
hline(0, "Zero Line", color=color.new(#787B86, 50))

// Plot MACD components
plot(hist, title="Histogram", style=plot.style_columns, color=(hist >= 0 ? (hist[1] < hist ? #26A69A : #B2DFDB) : (hist[1] < hist ? #FFCDD2 : #FF5252)))
plot(macd, title="MACD", color=#2962FF, linewidth=2)
plot(signal, title="Signal", color=#FF6D00, linewidth=2)


// Plot divergence markers on the MACD line
// Bullish divergence triangle (green, pointing up) at MACD value
plotshape(bullishDiv ? macd : na, title="Bullish Divergence", style=shape.triangleup, size=size.small, color=color.green, location=location.absolute)

// Bearish divergence triangle (red, pointing down) at MACD value
plotshape(bearishDiv ? macd : na, title="Bearish Divergence", style=shape.triangledown, size=size.small, color=color.red, location=location.absolute)

// ====== DEBUG INFO ======
// Log values for debugging - every bar
logMsg1 = "Bar " + str.tostring(bar_index) + " | Close: " + str.tostring(close) + " | MACD: " + str.tostring(macd, "#.0000") + " | IsSwingLow: " + str.tostring(isSwingLow) + " | SwingLowArraySize: " + str.tostring(array.size(swingLows))
log.info(logMsg1)

// Display last 5 swing lows
swingLowsStr = ""
if array.size(swingLows) > 0
    for i = 0 to math.min(array.size(swingLows) - 1, 4)
        swingLowsStr := swingLowsStr + str.tostring(array.get(swingLows, i)) + "(" + str.tostring(array.get(swingLowMacds, i), "#.2f") + ") "

logMsg2 = "Last5SwingLows: " + swingLowsStr + " | LowestSwingLow: " + str.tostring(lowestSwingLow) + " | MACDAtLowest: " + str.tostring(macdAtLowestSwingLow, "#.2f") + " | MACDHigherLow: " + str.tostring(macdHigherLow) + " | MACDAboveSignal: " + str.tostring(macdAboveSignal) + " | BullDiv: " + str.tostring(bullishDiv)
log.info(logMsg2)

if bullishDiv
    log.warning("BULLISH DIVERGENCE DETECTED AT BAR " + str.tostring(bar_index) + " Close: " + str.tostring(close) + " | Recovering from Low: " + str.tostring(priceRecoveringFromLow) + " | MHL: " + str.tostring(macdHigherLow) + " | MACDAboveSignal: " + str.tostring(macdAboveSignal))

// Log all swing high detections
if isSwingHigh
    log.info("NEW SWING HIGH at Bar " + str.tostring(bar_index) + " | Close: " + str.tostring(close) + " | MACD: " + str.tostring(macd, "#.00"))

if bearishDiv
    log.error("BEARISH DIV FIRED at Bar " + str.tostring(bar_index) + " | IsSwingHigh: " + str.tostring(isSwingHigh) + " | Close: " + str.tostring(close) + " | PriceDeclineFromHigh: " + str.tostring(priceDeclingFromHigh) + " | MLH: " + str.tostring(macdLowerHigh) + " | MACDBelowSignal: " + str.tostring(macdBelowSignal) + " | BarsFromHigh: " + str.tostring(bar_index - barsFromHighestSwingHigh) + " | OldEnough: " + str.tostring(swingHighOldEnough))
else if priceDeclingFromHigh and macdBelowSignal and array.size(swingHighs) == 5
    log.warning("POTENTIAL BEARISH at Bar " + str.tostring(bar_index) + " | IsSwingHigh: " + str.tostring(isSwingHigh) + " | MLH: " + str.tostring(macdLowerHigh) + " | OldEnough: " + str.tostring(swingHighOldEnough))
