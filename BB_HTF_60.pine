//@version=6
indicator(shorttitle="BB_HTF_60", title="Bollinger Bands HTF 60", overlay=true, timeframe="", timeframe_gaps=true)

// Higher Timeframe Selection
htf = input.timeframe("60", title="Higher Timeframe")

// BB Parameters
length = input.int(20, minval=1, title="BB Length")
mult1 = input.float(1.0, minval=0.001, maxval=50, title="StdDev 1 Multiplier")
mult2 = input.float(2.0, minval=0.001, maxval=50, title="StdDev 2 Multiplier")

// Color Inputs
upperColor = input(defval=#1E90FF, title="Upper Band Color")
lowerColor = input(defval=#1E90FF, title="Lower Band Color")
basisColor = input(defval=#00CED1, title="Basis Color")
upperColor2 = input(defval=#00D9FF, title="Upper Band 2 Color")
lowerColor2 = input(defval=#00D9FF, title="Lower Band 2 Color")
ema9Color = input(defval=#39FF14, title="EMA9 Color")
fillColorUp = input(defval=color.new(#39FF14, 85), title="EMA9 Above Basis Fill Color")
fillColorDown = input(defval=color.new(#1E90FF, 85), title="EMA9 Below Basis Fill Color")

// Line Width Inputs
upperWidth = input.int(2, minval=1, maxval=5, title="Upper Band Width")
lowerWidth = input.int(2, minval=1, maxval=5, title="Lower Band Width")
basisWidth = input.int(2, minval=1, maxval=5, title="Basis Width")

// MA Function
ma(source, length) =>
    ta.ema(source, length)

// Request HTF Data
htf_ema9 = request.security(syminfo.tickerid, htf, ta.ema(close, 9), lookahead=barmerge.lookahead_off, gaps=barmerge.gaps_on)
htf_close = request.security(syminfo.tickerid, htf, close, lookahead=barmerge.lookahead_off, gaps=barmerge.gaps_on)
htf_stdev = request.security(syminfo.tickerid, htf, ta.stdev(close, length), lookahead=barmerge.lookahead_off, gaps=barmerge.gaps_on)

// Calculate HTF BB
htf_basis = request.security(syminfo.tickerid, htf, ma(close, length), lookahead=barmerge.lookahead_off, gaps=barmerge.gaps_on)
htf_dev = mult1 * htf_stdev
htf_dev2 = mult2 * htf_stdev
htf_upper = htf_basis + htf_dev
htf_lower = htf_basis - htf_dev
htf_upper2 = htf_basis + htf_dev2
htf_lower2 = htf_basis - htf_dev2

// Plotting
offset = input.int(0, "Offset", minval = -500, maxval = 500, display = display.data_window)

// Track last valid fill color
var lastValidFillColor = fillColorUp
if not na(htf_ema9) and not na(htf_basis)
    lastValidFillColor := htf_ema9 > htf_basis ? fillColorUp : fillColorDown

p_ema9 = plot(htf_ema9, "HTF EMA9", color=ema9Color, linewidth=2, offset=offset, linestyle=plot.linestyle_dotted)
p_basis = plot(htf_basis, "HTF Basis", color=basisColor, linewidth=2, offset=offset, linestyle=plot.linestyle_dotted)
fill(p_ema9, p_basis, color=lastValidFillColor, title="EMA9-Basis Fill")
plot(htf_upper, "HTF Upper 1", color=upperColor, linewidth=1, offset=offset, linestyle=plot.linestyle_solid)
plot(htf_lower, "HTF Lower 1", color=lowerColor, linewidth=1, offset=offset, linestyle=plot.linestyle_solid)
plot(htf_upper2, "HTF Upper 2", color=upperColor2, linewidth=1, offset=offset, linestyle=plot.linestyle_solid)
plot(htf_lower2, "HTF Lower 2", color=lowerColor2, linewidth=1, offset=offset, linestyle=plot.linestyle_solid)
