//@version=6
indicator(title="VV Moving Average Convergence Divergence SRI", shorttitle="VMACDv2", timeframe="", timeframe_gaps=true)
// Getting inputs
fast_length = input(title = "Fast Length", defval = 12)
slow_length = input(title = "Slow Length", defval = 26)
src = input(title = "Source", defval = close)
signal_length = input.int(title = "Signal Smoothing",  minval = 1, maxval = 50, defval = 9, display = display.data_window)
sma_source = input.string(title = "Oscillator MA Type",  defval = "EMA", options = ["SMA", "EMA"], display = display.data_window)
sma_signal = input.string(title = "Signal Line MA Type", defval = "EMA", options = ["SMA", "EMA"], display = display.data_window)
vol_length = input.int(20, "Volume MA Length", display = display.data_window)

// Calculating - Volume-Weighted MACD
fast_ma = ta.ema(src * volume, fast_length) / ta.ema(volume, fast_length)
slow_ma = ta.ema(src * volume, slow_length) / ta.ema(volume, slow_length)
macd = fast_ma - slow_ma
signal = ta.ema(macd, signal_length)
hist = macd - signal

// Calculating - Traditional MACD on price (for divergence detection)
fast_ma_price = sma_source == "SMA" ? ta.sma(src, fast_length) : ta.ema(src, fast_length)
slow_ma_price = sma_source == "SMA" ? ta.sma(src, slow_length) : ta.ema(src, slow_length)
macd_price = fast_ma_price - slow_ma_price
signal_price = sma_signal == "SMA" ? ta.sma(macd_price, signal_length) : ta.ema(macd_price, signal_length)

// Volume Strength Filter
vol_avg = ta.sma(volume, vol_length)
vol_strength = volume > vol_avg

// Volume Divergence Detection with A/D
var cumVol = 0.
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")
ad = ta.cum(close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume)

ad_trend = ad > ta.sma(ad, 5)
macd_trend = macd_price > 0
divergence = ad_trend != macd_trend

// Divergence Alert Conditions
bullish_divergence = ad_trend and not macd_trend and macd_price < 0
bearish_divergence = not ad_trend and macd_trend and macd_price > 0
alertcondition(bullish_divergence, title = 'Bullish Divergence', message = 'Bullish Divergence: A/D trending up but MACD trending down')
alertcondition(bearish_divergence, title = 'Bearish Divergence', message = 'Bearish Divergence: A/D trending down but MACD trending up')

hline(0, "Zero Line", color = color.new(#787B86, 50))

// Enhanced histogram coloring - with volume strength
hist_color = (hist >= 0 ? (hist[1] < hist ? (vol_strength ? #1B5E20 : #26A69A) : #B2DFDB) : (hist[1] < hist ? (vol_strength ? #B71C1C : #FFCDD2) : #FF5252))
plot(hist, title = "Histogram", style = plot.style_columns, color = hist_color)
plot(macd,   title = "VWMACD",   color = #2962FF, linewidth = 2)
plot(signal, title = "Signal", color = #FF6D00, linewidth = 2)

// Background color alert for divergence
bgcolor(bullish_divergence ? color.new(color.green, 85) : (bearish_divergence ? color.new(color.red, 85) : na), title = "Divergence Background")