//@version=6
indicator(title="Directional Movement Index", shorttitle="DMIv2", timeframe="", timeframe_gaps=true)

// Inputs
lensig = input.int(14, title="ADX Smoothing", minval=1)
len = input.int(14, minval=1, title="DI Length")
vol_length = input.int(20, "Volume MA Length", display = display.data_window)

// DMI Calculation
up = ta.change(high)
down = -ta.change(low)
plusDM = na(up) ? na : (up > down and up > 0 ? up : 0)
minusDM = na(down) ? na : (down > up and down > 0 ? down : 0)
trur = ta.rma(ta.tr, len)
plus = fixnan(100 * ta.rma(plusDM, len) / trur)
minus = fixnan(100 * ta.rma(minusDM, len) / trur)
sum = plus + minus
adx = 100 * ta.rma(math.abs(plus - minus) / (sum == 0 ? 1 : sum), lensig)

// A/D Divergence Detection
var cumVol = 0.
cumVol += nz(volume)
if barstate.islast and cumVol == 0
    runtime.error("No volume is provided by the data vendor.")
ad = ta.cum(close==high and close==low or high==low ? 0 : ((2*close-low-high)/(high-low))*volume)

ad_trend = ad > ta.sma(ad, 5)
dmi_trend = plus > minus
divergence = ad_trend != dmi_trend

// Divergence Alert Conditions
bullish_divergence = ad_trend and not dmi_trend and plus < minus
bearish_divergence = not ad_trend and dmi_trend and plus > minus
alertcondition(bullish_divergence, title = 'Bullish Divergence', message = 'Bullish Divergence: A/D trending up but DMI trending down')
alertcondition(bearish_divergence, title = 'Bearish Divergence', message = 'Bearish Divergence: A/D trending down but DMI trending up')

// ADX Level Alerts
alertcondition(adx > 40, title = 'Strong Trend', message = 'Strong trend detected: ADX > 40')
alertcondition(adx > 20 and adx[1] <= 20, title = 'ADX Crosses 20', message = 'ADX crossed above 20 - trend starting')
alertcondition(adx < 20 and adx[1] >= 20, title = 'ADX Crosses 20 Down', message = 'ADX crossed below 20 - trend weakening')

// DI Crossover Alerts
alertcondition(plus > minus and plus[1] <= minus[1], title = '+DI Crosses Above -DI', message = '+DI crossed above -DI - bullish signal')
alertcondition(plus < minus and plus[1] >= minus[1], title = '+DI Crosses Below -DI', message = '+DI crossed below -DI - bearish signal')

// Plot DMI lines
plot(adx, color=#F50057, title="ADX", linewidth=2)
plot(plus, color=#2962FF, title="+DI", linewidth=2)
plot(minus, color=#FF6D00, title="-DI", linewidth=2)

// Divergence background alert
bgcolor(bullish_divergence ? color.new(color.green, 85) : (bearish_divergence ? color.new(color.red, 85) : na), title = "Divergence Background")