//@version=6
indicator(title="MACD Divergence Optimizer", shorttitle="VMACD-DIV", overlay=false)

// ====== INPUT PARAMETERS ======
fast_length = input.int(12, "MACD Fast Length")
slow_length = input.int(26, "MACD Slow Length")
signal_length = input.int(9, "Signal Smoothing")
lookback = input.int(75, "Lookback Bars")
minStrength = input.float(0.5, "Min Divergence Strength (%)")

// ====== MACD CALCULATION (Volume-Weighted) ======
fast_ma = ta.ema(close * volume, fast_length) / ta.ema(volume, fast_length)
slow_ma = ta.ema(close * volume, slow_length) / ta.ema(volume, slow_length)
macd = fast_ma - slow_ma
signal = ta.ema(macd, signal_length)
hist = macd - signal

// ====== DIVERGENCE DETECTION ======
// Track last 5 swing lows and highs with their MACD values
var array<float> swingLows = array.new<float>(5)
var array<float> swingLowMacds = array.new<float>(5)
var array<int> swingLowBars = array.new<int>(5)

var array<float> swingHighs = array.new<float>(5)
var array<float> swingHighMacds = array.new<float>(5)
var array<int> swingHighBars = array.new<int>(5)

// Detect local low (5-bar low)
isSwingLow = close == ta.lowest(close, 5)
if isSwingLow and bar_index > 5
    // Shift array left and add new swing low at end
    array.shift(swingLows)
    array.shift(swingLowMacds)
    array.shift(swingLowBars)
    array.push(swingLows, close)
    array.push(swingLowMacds, macd)
    array.push(swingLowBars, bar_index)

// Detect local high (5-bar high)
isSwingHigh = close == ta.highest(close, 5)
if isSwingHigh and bar_index > 5
    // Shift array left and add new swing high at end
    array.shift(swingHighs)
    array.shift(swingHighMacds)
    array.shift(swingHighBars)
    array.push(swingHighs, close)
    array.push(swingHighMacds, macd)
    array.push(swingHighBars, bar_index)

// ====== BULLISH DIVERGENCE ======
// Hidden divergence: Recovering from a swing low with stronger MACD
// Fires when price recovers ABOVE the lowest swing low
// AND current MACD is HIGHER than MACD at that lowest swing low  
// AND MACD crosses above zero (momentum recovering)

lowestSwingLow = array.min(swingLows)
lowestSwingLowIdx = array.indexof(swingLows, lowestSwingLow)
macdAtLowestSwingLow = array.get(swingLowMacds, lowestSwingLowIdx)

// Check if we're recovering FROM the swing low (price above it, MACD stronger)
priceRecoveringFromLow = close > lowestSwingLow
macdHigherLow = macd > macdAtLowestSwingLow * (1 + minStrength/100)
macdCrossAboveZero = ta.crossover(hist, 0)

// Bullish divergence: recovery bar has stronger MACD than the swing low
bullishDiv = priceRecoveringFromLow and macdHigherLow and macdCrossAboveZero and array.size(swingLows) == 5

// ====== BEARISH DIVERGENCE ======
// Hidden divergence: Declining from a swing high with weaker MACD
// Fires when price declines BELOW the highest swing high
// AND current MACD is LOWER than MACD at that highest swing high
// AND MACD crosses below zero (momentum weakening)
// AND the swing high is at least 5+ bars old (filter noise)

highestSwingHigh = array.max(swingHighs)
highestSwingHighIdx = array.indexof(swingHighs, highestSwingHigh)
macdAtHighestSwingHigh = array.get(swingHighMacds, highestSwingHighIdx)
barsFromHighestSwingHigh = array.get(swingHighBars, highestSwingHighIdx)

// Check if we're declining FROM the swing high (price below it, MACD weaker)
// AND the swing high is old enough (at least 5 bars ago)
priceDeclingFromHigh = close < highestSwingHigh
macdLowerHigh = macd < macdAtHighestSwingHigh * (1 - minStrength/100)
macdCrossBelowZero = ta.crossunder(hist, 0)
swingHighOldEnough = (bar_index - barsFromHighestSwingHigh) >= 5

// Bearish divergence: decline bar has weaker MACD than the swing high (and swing high is established)
bearishDiv = priceDeclingFromHigh and macdLowerHigh and macdCrossBelowZero and array.size(swingHighs) == 5 and swingHighOldEnough

// ====== ALERTS ======
alertcondition(bullishDiv, title="Bullish Divergence", message="ðŸŸ¢ BULLISH DIVERGENCE - Price Low but MACD Higher - BUY SIGNAL")
alertcondition(bearishDiv, title="Bearish Divergence", message="ðŸ”´ BEARISH DIVERGENCE - Price High but MACD Lower - SELL SIGNAL")

// ====== VISUALS ======
hline(0, "Zero Line", color=color.new(#787B86, 50))

// Plot MACD components
plot(hist, title="Histogram", style=plot.style_columns, color=(hist >= 0 ? (hist[1] < hist ? #26A69A : #B2DFDB) : (hist[1] < hist ? #FFCDD2 : #FF5252)))
plot(macd, title="MACD", color=#2962FF, linewidth=2)
plot(signal, title="Signal", color=#FF6D00, linewidth=2)


// Plot divergence markers on the MACD line
// Bullish divergence triangle (green, pointing up) at MACD value
plotshape(bullishDiv ? macd : na, title="Bullish Divergence", style=shape.triangleup, size=size.tiny, color=color.green, location=location.absolute)

// Bearish divergence triangle (red, pointing down) at MACD value
plotshape(bearishDiv ? macd : na, title="Bearish Divergence", style=shape.triangledown, size=size.tiny, color=color.red, location=location.absolute)

// ====== DEBUG INFO ======
// Log values for debugging - every bar
logMsg1 = "Bar " + str.tostring(bar_index) + " | Close: " + str.tostring(close) + " | MACD: " + str.tostring(macd, "#.0000") + " | IsSwingLow: " + str.tostring(isSwingLow) + " | SwingLowArraySize: " + str.tostring(array.size(swingLows))
log.info(logMsg1)

// Display last 5 swing lows
swingLowsStr = ""
if array.size(swingLows) > 0
    for i = 0 to math.min(array.size(swingLows) - 1, 4)
        swingLowsStr := swingLowsStr + str.tostring(array.get(swingLows, i)) + "(" + str.tostring(array.get(swingLowMacds, i), "#.2f") + ") "

logMsg2 = "Last5SwingLows: " + swingLowsStr + " | LowestSwingLow: " + str.tostring(lowestSwingLow) + " | MACDAtLowest: " + str.tostring(macdAtLowestSwingLow, "#.2f") + " | MACDHigherLow: " + str.tostring(macdHigherLow) + " | CrossAbove: " + str.tostring(macdCrossAboveZero) + " | BullDiv: " + str.tostring(bullishDiv)
log.info(logMsg2)

if bullishDiv
    log.warning("BULLISH DIVERGENCE DETECTED AT BAR " + str.tostring(bar_index) + " Close: " + str.tostring(close) + " | Recovering from Low: " + str.tostring(priceRecoveringFromLow) + " | MHL: " + str.tostring(macdHigherLow) + " | CrossAbove: " + str.tostring(macdCrossAboveZero))

if bearishDiv
    log.error("BEARISH DIVERGENCE DETECTED AT BAR " + str.tostring(bar_index) + " Close: " + str.tostring(close) + " | Declining from High: " + str.tostring(priceDeclingFromHigh) + " | MLH: " + str.tostring(macdLowerHigh) + " | CrossBelow: " + str.tostring(macdCrossBelowZero))
